#!/bin/bash

CLYDE_TMP=clyde-tmp
CHROOT=chroot
USE_CHROOT=0
PACKAGE="$2"
SUDO=doas

if [[ "${1-}" =~ ^-*h(elp)?$ ]]; then
	echo 'Usage: insert some useful help statement that ill probably use chatgpt to write later on lmao'
	exit
fi

cd ~
if [ "$1" = "install" ]
then
	URL=https://aur.archlinux.org/$PACKAGE.git
	OPTION="n"
	mkdir -p $CLYDE_TMP/$CHROOT
	cd $CLYDE_TMP

	# Check if package exists
	if curl -s --request GET "https://aur.archlinux.org/rpc/?v=5&type=info&arg[]=$PACKAGE" | grep '"resultcount":0' > /dev/null
	then
	       echo "Package ${PACKAGE} not found"
	       exit
	else
		read -p "Install ${PACKAGE}? [y/N]: " $OPTION
		if [[ "{$OPTION}" == "n" || "{$OPTION}" == "N" ]]
		then
			echo "Canceled by the user! Exiting..."
			rm -rf $CLYDE_TMP # Should be fine since there's no chroot yet
			exit
		fi
		git clone $URL # clone
		cd $PACKAGE

		if [ "$USE_CHROOT" -eq 1 ] 
		then
			echo "Making chroot..."
			mkarchroot ~/$CLYDE_TMP/$CHROOT/root base-devel > /dev/null
			arch-nspawn ~/$CLYDE_TMP/$CHROOT/root pacman -Syu > /dev/null

			echo "Building..."
			makechrootpkg -c -r ~/$CLYDE_TMP/$CHROOT # build
			grep ~/$CLYDE_TMP/$PACKAGE/$PACKAGE-*.pkg.tar.zst | $SUDO pacman -U  # install
		else
			makepkg -si
			grep ~/$CLYDE_TMP/$PACKAGE/$PACKAGE-*.pkg.tar.zst | $SUDO pacman -U  # install
		fi

		# Clean up
		echo "Cleaning up..."
		cd ~
		$SUDO rm -rf $CLYDE_TMP
	fi
fi

if [ "$1" = "yeet" ]
then 
	$SUDO pacman -Rn $PACKAGE
fi

